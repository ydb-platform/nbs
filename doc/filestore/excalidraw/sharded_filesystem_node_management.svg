<svg version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1858.5381469726553 13745.000000000005" width="1858.5381469726553" height="13745.000000000005">
  <!-- svg-source:excalidraw -->
  
  <defs>
    <style class="style-fonts">
      @font-face { font-family: Virgil; src: url(data:font/woff2;base64,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); }
    </style>
    
  </defs>
  <rect x="0" y="0" width="1858.5381469726553" height="13745.000000000005" fill="#ffffff"></rect><g transform="translate(16.66666666666606 851.6666666666715) rotate(0 842.3922729492188 90)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Nodes (inodes) can be created via CreateNode and CreateHandle requests. CreateHandle can</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">lead to node creation if the E_CREATE flag is set (O_CREAT in POSIX). CreateHandle with</text><text x="0" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">E_CREATE works similarly to CreateNode so I'll focus on CreateNode here.</text><text x="0" y="166.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"></text></g><g transform="translate(10 755.8333333333358) rotate(0 122.36402893066406 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1971c2" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Node creation</text></g><g transform="translate(12.03061930338572 10) rotate(0 866.9583129882812 315)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Each inode is managed by a single tablet (shard or main tablet). Shards are</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">in charge of regular inodes (i.e. files) by default but other kinds of inodes -</text><text x="0" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">most importantly directories - can be created in shards if DirectoryCreationInShardsEnabled</text><text x="0" y="166.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">storage config flag is enabled. </text><text x="0" y="211.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"></text><text x="0" y="256.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Requests are routed to the right shard in TStorageServiceActor. Higher bits (default - 8 bits)</text><text x="0" y="301.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">of NodeId and HandleId store ShardNo - it's used to select the right shard. Without</text><text x="0" y="346.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">DirectoryCreationInShardsEnabled only CreateHandle w/o Name, DestroyHandle, WriteData,</text><text x="0" y="391.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">AddData, GenerateBlobIds, ReadData, DescribeData and GetNodeAttr w/o Name requests are</text><text x="0" y="436.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">sent directly to the right shard. All other requests - that is, mostly the requests that involve</text><text x="0" y="481.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">file names - are sent to the main tablet first.</text><text x="0" y="526.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"></text><text x="0" y="571.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">If DirectoryCreationInShardsEnabled is on, the shard that's in charge of the parent directory</text><text x="0" y="616.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">of the affected file plays the role of the main tablet (aka directory tablet).</text></g><g stroke-linecap="round" transform="translate(35 1099.1666666666715) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C185.53 0.91, 342.51 1.12, 423 0 C445.19 1.39, 456.69 9.05, 455 32 C457.75 107.16, 455.76 184.81, 455 256.33 C456.08 279.51, 446.19 290.16, 423 288.33 C307.52 289.96, 194.84 288.11, 32 288.33 C11.9 285.56, -1.75 275.94, 0 256.33 C1.89 201.39, 2.41 152.58, 0 32 C1.5 8.85, 13.02 -1.29, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C130.04 2.25, 228.29 2.25, 423 0 M32 0 C136.86 -0.91, 242.36 -0.26, 423 0 M423 0 C443.39 -0.26, 453.93 9.3, 455 32 M423 0 C443.25 -0.04, 455.63 10.11, 455 32 M455 32 C454.12 78.1, 454.56 121.98, 455 256.33 M455 32 C455.7 90.22, 455.64 148.28, 455 256.33 M455 256.33 C453.24 275.88, 443.04 288.29, 423 288.33 M455 256.33 C454.06 275.42, 446.53 287.76, 423 288.33 M423 288.33 C317.13 288.53, 208.76 288.38, 32 288.33 M423 288.33 C311.97 288.06, 201.99 287.12, 32 288.33 M32 288.33 C11.65 290.18, -1.91 278.4, 0 256.33 M32 288.33 C12.71 290.48, -1.97 277.17, 0 256.33 M0 256.33 C1.78 200.87, 2.44 142.67, 0 32 M0 256.33 C0.98 172.64, 0.76 87.53, 0 32 M0 32 C1.69 8.73, 12.34 1.8, 32 0 M0 32 C-0.13 11.1, 10.15 1.69, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(67.07789611816406 1220.8333333333394) rotate(0 195.42210388183594 22.5)"><text x="195.42210388183594" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">TStorageServiceActor</text></g><g stroke-linecap="round" transform="translate(794.166666666667 1088.3333333333358) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C182.63 0.45, 330.83 -0.69, 423 0 C445.68 -1.37, 451.56 10.43, 455 32 C457.12 82.31, 456.96 130.48, 455 256.33 C455.59 274.22, 444.89 286.72, 423 288.33 C297.99 286.42, 173.06 287.08, 32 288.33 C9.2 288.08, 0.82 276.37, 0 256.33 C0.51 205.1, 1.63 149.57, 0 32 C-3.57 8.77, 11.85 2.41, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C122.64 -1.2, 213.43 -0.01, 423 0 M32 0 C165.36 -1.64, 298.57 -1.79, 423 0 M423 0 C443.65 -0.05, 453.65 10.17, 455 32 M423 0 C446.34 -2.25, 456.07 10.44, 455 32 M455 32 C455.59 118.16, 455.04 205.8, 455 256.33 M455 32 C455.22 112.01, 455.23 192.84, 455 256.33 M455 256.33 C453.36 279.36, 443.41 288.55, 423 288.33 M455 256.33 C454.97 277.04, 444.21 286.37, 423 288.33 M423 288.33 C322.43 290.88, 225.15 290.45, 32 288.33 M423 288.33 C275.75 290.55, 128.22 290.65, 32 288.33 M32 288.33 C12.09 286.73, 0.33 279.01, 0 256.33 M32 288.33 C10.18 289.15, 0.67 276.49, 0 256.33 M0 256.33 C-0.54 184.83, 0.1 112.47, 0 32 M0 256.33 C-1.18 196.62, -0.19 137.37, 0 32 M0 32 C1.79 11.84, 9 1.25, 32 0 M0 32 C2.13 10.34, 8.76 1.85, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(918.4546305338545 1210.0000000000036) rotate(0 103.2120361328125 22.5)"><text x="103.2120361328125" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Main tablet</text></g><g stroke-linecap="round" transform="translate(755.8333333333339 1476.6666666666752) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C141.15 -1.07, 254.82 -1.35, 423 0 C446.41 -0.79, 456.83 10.57, 455 32 C454.24 83.83, 453.3 137.64, 455 256.33 C453.15 281.1, 440.84 285.34, 423 288.33 C334.67 289.35, 245.22 287.14, 32 288.33 C10.71 288.72, 2.21 276.6, 0 256.33 C-0.8 180.86, -0.44 106.64, 0 32 C-1.04 13.46, 11.14 -3.09, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C150.27 -2.3, 269.36 -2.21, 423 0 M32 0 C151.57 1.84, 272.37 1.17, 423 0 M423 0 C445.52 -0.98, 454.53 12.01, 455 32 M423 0 C446.08 1.2, 455.02 11.5, 455 32 M455 32 C456.7 112.87, 456.16 197.59, 455 256.33 M455 32 C454.79 101.67, 455.18 173.26, 455 256.33 M455 256.33 C454.77 278.52, 443.12 286.46, 423 288.33 M455 256.33 C456.2 276.47, 445.06 290.48, 423 288.33 M423 288.33 C279.33 286.47, 138 287.4, 32 288.33 M423 288.33 C266.91 288.94, 110.32 288.48, 32 288.33 M32 288.33 C9.03 289.26, 0.9 278.09, 0 256.33 M32 288.33 C10.99 289.91, -0.14 276.71, 0 256.33 M0 256.33 C0.54 201.8, 1.28 146.25, 0 32 M0 256.33 C-0.98 168.08, -1.39 80.67, 0 32 M0 32 C0.59 9.28, 11.59 -1.9, 32 0 M0 32 C0.43 11.79, 12.61 -1.81, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(933.5093053181972 1598.333333333343) rotate(0 49.82402801513672 22.5)"><text x="49.82402801513672" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Shard</text></g><g stroke-linecap="round" transform="translate(710.8333333333335 1513.3333333333358) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C151.22 -0.3, 266.95 0.92, 423 0 C446.41 3.33, 454.82 9.4, 455 32 C449.17 117.32, 451.35 205.07, 455 256.33 C456.37 276.36, 446.94 288.52, 423 288.33 C291.19 290.49, 163.62 292.31, 32 288.33 C10.52 290.96, -3.46 274.53, 0 256.33 C-0.85 198.8, 2.7 140.99, 0 32 C-1.92 12.86, 8.12 2.14, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C177.91 1.61, 324.72 1.05, 423 0 M32 0 C143.93 0.2, 256.48 0.68, 423 0 M423 0 C444.28 0.7, 456.68 10.54, 455 32 M423 0 C444.28 -1.84, 453.76 10.47, 455 32 M455 32 C455.76 92.15, 453.62 150.67, 455 256.33 M455 32 C455.82 109.03, 455.97 186.46, 455 256.33 M455 256.33 C456.82 277.84, 443.28 289.16, 423 288.33 M455 256.33 C456.51 279.3, 444.9 287.65, 423 288.33 M423 288.33 C317.36 287.1, 213.13 287.51, 32 288.33 M423 288.33 C288.49 285.88, 154.45 286.15, 32 288.33 M32 288.33 C9.42 288.23, -1.28 277.14, 0 256.33 M32 288.33 C9.36 287.32, -1.06 277.99, 0 256.33 M0 256.33 C2.57 197.03, 2.94 133.25, 0 32 M0 256.33 C0.48 188.19, 0.11 119.79, 0 32 M0 32 C1.54 10.44, 12.46 -1.69, 32 0 M0 32 C-0.38 12.15, 8.8 -2.05, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(888.5093053181968 1635.0000000000036) rotate(0 49.82402801513672 22.5)"><text x="49.82402801513672" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Shard</text></g><g stroke-linecap="round" transform="translate(657.5000000000002 1563.3333333333394) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C149.43 3.19, 265.03 2.67, 423 0 C441.6 -2.93, 457.25 10.42, 455 32 C454.48 119.95, 449.76 210.73, 455 256.33 C453.44 276.83, 446.57 288.99, 423 288.33 C320.07 283.62, 222.92 285.46, 32 288.33 C9.78 290.17, -2.46 274.92, 0 256.33 C-3.1 185.67, -4.66 117.65, 0 32 C0.32 8.07, 12.33 -0.52, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C117.06 -0.32, 201.75 -0.63, 423 0 M32 0 C176.68 -1.4, 321.18 -0.95, 423 0 M423 0 C443.23 -0.69, 455.25 10.08, 455 32 M423 0 C446.4 -1.96, 454.75 9.86, 455 32 M455 32 C456.79 78.36, 454.69 127.09, 455 256.33 M455 32 C454.19 81.8, 454.15 131.17, 455 256.33 M455 256.33 C454.51 279.62, 445.3 286.77, 423 288.33 M455 256.33 C452.98 275.99, 443.1 288.87, 423 288.33 M423 288.33 C297.37 285.94, 171.61 285.76, 32 288.33 M423 288.33 C313.05 286.99, 203.01 287.67, 32 288.33 M32 288.33 C12.03 289.86, 1.86 276.13, 0 256.33 M32 288.33 C11.27 290.53, -1.96 277.47, 0 256.33 M0 256.33 C2.67 209.33, 2.35 161.65, 0 32 M0 256.33 C-1.65 167.96, -1.33 80.77, 0 32 M0 32 C1.01 10.08, 11.16 -1.18, 32 0 M0 32 C-0.18 10.62, 12.34 1.75, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(835.1759719848635 1685.0000000000073) rotate(0 49.82402801513672 22.5)"><text x="49.82402801513672" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Shard</text></g><g stroke-linecap="round"><g transform="translate(489.9999999999998 1239.1666666666715) rotate(0 149.9999999999999 0)"><path d="M-0.93 -0.28 C49.09 -0.21, 250.26 0.19, 300.54 0.28 M0.78 -1.47 C50.65 -1.77, 249.94 -2.22, 299.87 -1.7" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(489.9999999999998 1239.1666666666715) rotate(0 149.9999999999999 0)"><path d="M276.35 6.78 C283.76 5.03, 292.55 2.53, 299.87 -1.7 M276.35 6.78 C283.53 5.11, 291.24 1.44, 299.87 -1.7" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(489.9999999999998 1239.1666666666715) rotate(0 149.9999999999999 0)"><path d="M276.41 -10.32 C283.78 -6.36, 292.55 -3.14, 299.87 -1.7 M276.41 -10.32 C283.56 -6.52, 291.25 -4.72, 299.87 -1.7" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(556.6666666666663 1155.833333333343) rotate(0 103.50602722167969 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">CreateNode</text></g><g transform="translate(14.99999999999909 1914.1666666666715) rotate(0 838.54833984375 135)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Shard selection takes place in TStorageServiceActor and, if ShardIdSelectionInLeaderEnabled</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">storage config flag is on, main tablet selects the shard as well and selection in the main</text><text x="0" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">tablet overrides the shard selected in TStorageServiceActor.</text><text x="0" y="166.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"></text><text x="0" y="211.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Since ShardIdSelectionInLeaderEnabled is supposed to completely replace shard selection in</text><text x="0" y="256.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">TStorageServiceActor, this doc will focus on that mode.</text></g><g stroke-linecap="round" transform="translate(52.91666666666697 2273.3333333333394) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C141.49 -0.27, 252.67 -0.67, 423 0 C443.38 -1.98, 456.19 8.93, 455 32 C459.75 105.55, 455.84 185.49, 455 256.33 C452.38 278.96, 447.41 285.48, 423 288.33 C294.1 287.83, 161.84 285.2, 32 288.33 C9.36 286.92, 1.51 276.99, 0 256.33 C-1.69 193.6, 1.03 124.05, 0 32 C2.88 7.45, 7.3 -0.11, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C128 -0.98, 222.63 -2.59, 423 0 M32 0 C166.65 1.47, 300.74 1.54, 423 0 M423 0 C442.89 -1.21, 454.31 12.04, 455 32 M423 0 C442.47 -0.9, 456.17 9.64, 455 32 M455 32 C453.96 118.65, 454.62 206.13, 455 256.33 M455 32 C454.95 87.64, 454.59 142.68, 455 256.33 M455 256.33 C455.8 277.27, 443.34 288.3, 423 288.33 M455 256.33 C453.86 277.86, 444.82 289.44, 423 288.33 M423 288.33 C287.74 290.25, 149.93 290.21, 32 288.33 M423 288.33 C336.51 287.3, 248.58 286.87, 32 288.33 M32 288.33 C9.17 286.43, -0.21 276.76, 0 256.33 M32 288.33 C9.39 286.88, 0.82 277.5, 0 256.33 M0 256.33 C1.37 201.18, 1.66 141.55, 0 32 M0 256.33 C0.19 200.02, 1.34 143.05, 0 32 M0 32 C-0.4 10.22, 9.69 -1.81, 32 0 M0 32 C-1.01 9.79, 9.54 1.86, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(84.99456278483103 2395.0000000000073) rotate(0 195.42210388183594 22.5)"><text x="195.42210388183594" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">TStorageServiceActor</text></g><g stroke-linecap="round" transform="translate(812.0833333333335 2262.500000000011) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C137.9 0.75, 245.59 0.9, 423 0 C445.61 3.5, 452.19 12.27, 455 32 C449.91 88, 454.81 139.33, 455 256.33 C456.26 275.16, 443.12 291.85, 423 288.33 C288.63 284.09, 156.67 284.52, 32 288.33 C10.39 289.91, 1.1 277.47, 0 256.33 C-0.38 165.4, -5.75 79.9, 0 32 C-1.82 8.01, 13.75 -1.38, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C173.27 2.86, 313.01 2.24, 423 0 M32 0 C180.82 -2.48, 330.28 -1.73, 423 0 M423 0 C442.71 -0.78, 456.02 9.78, 455 32 M423 0 C446.4 -0.53, 453.85 9.87, 455 32 M455 32 C454.12 88.67, 454.09 147.52, 455 256.33 M455 32 C455.79 116.41, 455.02 201.16, 455 256.33 M455 256.33 C454.01 277.83, 444.76 289.3, 423 288.33 M455 256.33 C456.11 276.57, 445.38 290.15, 423 288.33 M423 288.33 C275.26 289.55, 128.5 291.03, 32 288.33 M423 288.33 C267.53 288.32, 112.86 288.61, 32 288.33 M32 288.33 C9.56 287.07, 0.71 277.52, 0 256.33 M32 288.33 C9.59 287.61, -1 278.68, 0 256.33 M0 256.33 C-2.02 166.91, -0.11 77.69, 0 32 M0 256.33 C-1.17 190.95, -1.42 125.18, 0 32 M0 32 C-0.88 9.9, 9.69 1.61, 32 0 M0 32 C-0.47 9.02, 10.49 0.22, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(936.371297200521 2384.166666666679) rotate(0 103.2120361328125 22.5)"><text x="103.2120361328125" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Main tablet</text></g><g stroke-linecap="round" transform="translate(537.0833333333339 2929.166666666679) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C128.5 4.01, 221.89 2.9, 423 0 C442.34 -2.95, 458.46 8.04, 455 32 C459.05 105.23, 456.92 185.79, 455 256.33 C456.5 278.92, 441.33 287.03, 423 288.33 C320.94 288.48, 219.84 287.45, 32 288.33 C14.02 291.3, -1.25 280.54, 0 256.33 C1.68 206.81, 5.9 160.68, 0 32 C0.16 9.11, 11.69 2.96, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C187.02 -1.1, 341.23 -1.78, 423 0 M32 0 C125.1 -1.78, 219.43 -1.82, 423 0 M423 0 C446.13 -0.46, 454 9.98, 455 32 M423 0 C443.3 0.08, 454.06 9.4, 455 32 M455 32 C455.22 92.64, 455.33 153.18, 455 256.33 M455 32 C453.61 94.87, 454.22 158.01, 455 256.33 M455 256.33 C455.97 276.71, 445.24 289.91, 423 288.33 M455 256.33 C456.74 276.26, 446 286.55, 423 288.33 M423 288.33 C321.17 289.59, 217.38 289.51, 32 288.33 M423 288.33 C342.63 286.93, 263.12 287.26, 32 288.33 M32 288.33 C9.73 287.7, -0.87 278.55, 0 256.33 M32 288.33 C12.85 289.74, -1.63 276.53, 0 256.33 M0 256.33 C-1.36 200.27, -2.83 142.08, 0 32 M0 256.33 C0.57 193.72, 0.53 132.45, 0 32 M0 32 C-0.41 9.24, 10.52 0.19, 32 0 M0 32 C-0.64 12.96, 9.6 -0.61, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(714.7593053181972 3050.8333333333467) rotate(0 49.82402801513672 22.5)"><text x="49.82402801513672" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Shard</text></g><g stroke-linecap="round" transform="translate(492.0833333333335 2965.833333333343) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C186.17 -3.53, 344.67 -3.34, 423 0 C445.63 3.08, 452.15 11.92, 455 32 C455.12 84.78, 451.24 134.29, 455 256.33 C453.58 279.18, 443.66 288.06, 423 288.33 C290.54 289.84, 153.45 289.79, 32 288.33 C7.45 284.97, -0.11 275.85, 0 256.33 C-2.84 204.26, -2.1 157.42, 0 32 C1.28 12.66, 13.61 2.42, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C143.14 1.24, 256.49 0.7, 423 0 M32 0 C134.56 0.88, 235.78 0.81, 423 0 M423 0 C443.43 0.07, 454.18 9.57, 455 32 M423 0 C443.61 -1.31, 456.48 12.44, 455 32 M455 32 C456.26 103.61, 456.57 176.08, 455 256.33 M455 32 C455.82 100.73, 455.8 170.97, 455 256.33 M455 256.33 C456.51 276.44, 445.78 286.78, 423 288.33 M455 256.33 C454.16 276.05, 446.4 290.55, 423 288.33 M423 288.33 C331.34 286.52, 241.37 285.99, 32 288.33 M423 288.33 C330.14 287.98, 237.57 288.42, 32 288.33 M32 288.33 C12.57 289.55, -1.41 276.68, 0 256.33 M32 288.33 C9.61 289.76, -1.86 277.45, 0 256.33 M0 256.33 C1.44 176.52, 0.27 97.65, 0 32 M0 256.33 C0.76 197.01, 0.88 139.01, 0 32 M0 32 C-0.55 12.66, 9.74 -0.53, 32 0 M0 32 C-1.27 11.42, 9.56 0.82, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(669.7593053181968 3087.500000000011) rotate(0 49.82402801513672 22.5)"><text x="49.82402801513672" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Shard</text></g><g stroke-linecap="round" transform="translate(438.75000000000045 3015.833333333343) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C118.06 4.77, 200.94 3.71, 423 0 C441.83 -1.21, 458.51 12.17, 455 32 C450.88 108.42, 451.52 182.01, 455 256.33 C456.58 278.77, 444.14 291.68, 423 288.33 C271.64 289.65, 123.95 290.55, 32 288.33 C8.01 291.42, -1.38 277.83, 0 256.33 C0.11 200.44, 1.54 143.2, 0 32 C-2.81 11.06, 11.83 0.38, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C135.36 2.44, 239.11 2.89, 423 0 M32 0 C140.03 0.81, 248.35 0.47, 423 0 M423 0 C443.7 -1.14, 456.28 12.21, 455 32 M423 0 C444.86 1.91, 455.92 10.21, 455 32 M455 32 C455.11 88.5, 455.79 145.11, 455 256.33 M455 32 C456.53 88.09, 456.5 144.56, 455 256.33 M455 256.33 C454.27 276.26, 446.13 290.26, 423 288.33 M455 256.33 C453.43 278.21, 442.62 286.14, 423 288.33 M423 288.33 C309.04 287.49, 196.46 286.53, 32 288.33 M423 288.33 C318.62 289.69, 212.72 289.05, 32 288.33 M32 288.33 C9.74 289.58, -1.62 277.48, 0 256.33 M32 288.33 C11.86 286.15, -0.46 277.15, 0 256.33 M0 256.33 C1.08 199.2, 3.13 143.4, 0 32 M0 256.33 C-0.09 205.94, -0.26 153.61, 0 32 M0 32 C-1.1 11.33, 9.7 0.71, 32 0 M0 32 C2.24 8.87, 11.69 -1.27, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(616.4259719848637 3137.500000000011) rotate(0 49.82402801513672 22.5)"><text x="49.82402801513672" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Shard</text></g><g stroke-linecap="round"><g transform="translate(507.91666666666606 2413.3333333333394) rotate(0 149.9999999999999 0)"><path d="M1.08 -0.28 C50.87 -0.26, 249.67 -0.47, 299.4 -0.41 M0.18 -1.47 C50.33 -1.23, 252.09 0.43, 301.8 0.9" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(507.91666666666606 2413.3333333333394) rotate(0 149.9999999999999 0)"><path d="M278.23 9.25 C286.08 5.11, 294.11 2.28, 301.8 0.9 M278.23 9.25 C285.1 6.27, 293.21 5.08, 301.8 0.9" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(507.91666666666606 2413.3333333333394) rotate(0 149.9999999999999 0)"><path d="M278.38 -7.85 C286.1 -5.99, 294.08 -2.82, 301.8 0.9 M278.38 -7.85 C285.14 -5.64, 293.2 -1.64, 301.8 0.9" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(574.583333333333 2330.000000000011) rotate(0 103.50602722167969 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">CreateNode</text></g><g stroke-linecap="round"><g transform="translate(1023.333333333333 2552.5000000000073) rotate(0 -148.33333333333326 206.66666666666606)"><path d="M-0.06 0.19 C-49.67 69.15, -247.85 344.56, -297.34 413.4 M-1.55 -0.75 C-50.8 68.44, -245.59 345.76, -294.99 414.98" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(1023.333333333333 2552.5000000000073) rotate(0 -148.33333333333326 206.66666666666606)"><path d="M-288.4 390.86 C-290.3 397.61, -292.66 406.05, -294.99 414.98 M-288.4 390.86 C-290.61 398.92, -291.62 404.23, -294.99 414.98" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(1023.333333333333 2552.5000000000073) rotate(0 -148.33333333333326 206.66666666666606)"><path d="M-274.44 400.74 C-280.88 404.25, -287.8 409.46, -294.99 414.98 M-274.44 400.74 C-280.68 405.87, -285.8 408.28, -294.99 414.98" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(946.6666666666665 2699.1666666666715) rotate(0 422.98211669921875 67.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Selects one of the shards in a round-robin-like</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">manner, but takes the amount of free space in</text><text x="0" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">each shard into account</text></g><g stroke-linecap="round" transform="translate(167.6428833007817 3551.666666666675) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C135.46 3.06, 233.43 1.47, 423 0 C442.14 1.37, 451.41 8.06, 455 32 C454.96 84.26, 449.14 139.01, 455 256.33 C451.69 278.81, 441.47 291.17, 423 288.33 C277.5 285.66, 129.69 285.68, 32 288.33 C11.98 284.96, -3.19 276.1, 0 256.33 C-0.53 173.71, -1.69 95.38, 0 32 C-2.6 8.58, 9.54 -0.68, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C130.71 -1.13, 227.86 -2.82, 423 0 M32 0 C181.5 -0.04, 331.65 -0.16, 423 0 M423 0 C443.8 1.28, 454.06 9.87, 455 32 M423 0 C445.43 -0.44, 452.87 8.82, 455 32 M455 32 C455.28 106.33, 455.59 183.93, 455 256.33 M455 32 C455.58 116.88, 455.86 201.44, 455 256.33 M455 256.33 C456.01 276.47, 442.67 288.74, 423 288.33 M455 256.33 C454.84 278.64, 442.45 286.46, 423 288.33 M423 288.33 C267.2 286.55, 110.76 287.62, 32 288.33 M423 288.33 C285.9 289.19, 148.93 289.23, 32 288.33 M32 288.33 C9.97 288.7, 1.41 278.56, 0 256.33 M32 288.33 C12.71 289.67, -1.07 278.45, 0 256.33 M0 256.33 C-1.08 196.24, 0.52 132.11, 0 32 M0 256.33 C0.3 196.34, -0.3 137.51, 0 32 M0 32 C-1.71 10.43, 12.35 -0.1, 32 0 M0 32 C-1.97 10.1, 11.46 0.4, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(291.9308471679692 3673.333333333343) rotate(0 103.2120361328125 22.5)"><text x="103.2120361328125" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Main tablet</text></g><g stroke-linecap="round" transform="translate(354.3095499674487 3961.6666666666715) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C162.81 1.1, 298.4 5.02, 423 0 C443.76 -3.23, 456.75 7.36, 455 32 C454.48 105.26, 449.54 181.01, 455 256.33 C456.54 274.13, 445.91 289.65, 423 288.33 C343.71 288.36, 263.67 288.23, 32 288.33 C9.79 289.85, 3.25 275.07, 0 256.33 C1.14 199.76, 4.1 147.32, 0 32 C3.16 9.92, 10.48 -1.39, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C159.8 1.29, 287.84 -0.08, 423 0 M32 0 C174.55 0.79, 316 0.44, 423 0 M423 0 C445.1 0.72, 453.7 10.19, 455 32 M423 0 C442.17 -0.13, 455.06 12.42, 455 32 M455 32 C455.18 109.79, 455.49 188.64, 455 256.33 M455 32 C453.33 86.23, 452.69 139.03, 455 256.33 M455 256.33 C456.99 278.98, 443.12 288.91, 423 288.33 M455 256.33 C454.2 277.71, 445.64 289.49, 423 288.33 M423 288.33 C316.45 287.83, 209.72 287.54, 32 288.33 M423 288.33 C299.07 289.69, 173.83 289.55, 32 288.33 M32 288.33 C10.14 288.24, -0.7 276.31, 0 256.33 M32 288.33 C12.4 288.91, -1.93 276.87, 0 256.33 M0 256.33 C-0.48 190.9, 0.95 126.24, 0 32 M0 256.33 C-2.36 191.48, -1.33 127.2, 0 32 M0 32 C-0.8 12.55, 9.09 1.78, 32 0 M0 32 C-0.18 8.72, 8.74 -1.4, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(531.985521952312 4083.3333333333394) rotate(0 49.82402801513672 22.5)"><text x="49.82402801513672" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Shard</text></g><g transform="translate(53.33333333333303 3414.166666666675) rotate(0 817.8482666015625 45)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Ok, so a shard was selected, now let's focus on the main tablet + shard pair. Main tablet</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">generates NodeNameInShard - simply as a GUID.</text></g><g stroke-linecap="round"><g transform="translate(629.9999999999998 3689.1666666666715) rotate(0 241.66666666666663 -1.6666666666660603)"><path d="M-0.39 -0.3 C80.07 -1.09, 402.62 -3.67, 483.3 -4.26 M1.6 -1.5 C81.86 -2.21, 402.08 -3, 482.34 -3.21" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(629.9999999999998 3689.1666666666715) rotate(0 241.66666666666663 -1.6666666666660603)"><path d="M458.87 5.4 C466.36 2.49, 473.34 0.23, 482.34 -3.21 M458.87 5.4 C464.97 2.66, 470.08 0.21, 482.34 -3.21" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(629.9999999999998 3689.1666666666715) rotate(0 241.66666666666663 -1.6666666666660603)"><path d="M458.82 -11.7 C466.4 -8.77, 473.4 -5.17, 482.34 -3.21 M458.82 -11.7 C465.08 -9.99, 470.2 -7.98, 482.34 -3.21" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(658.3333333333333 3604.1666666666715) rotate(0 216.17807006835938 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">LocalDB CreateNode tx</text></g><g stroke-linecap="round" transform="translate(1116.6666666666665 3534.1666666666715) rotate(0 223.33333333333326 228.33333333333212)"><path d="M32 0 C127.68 -1.86, 225.54 -3.49, 414.67 0 C435.68 3.24, 447.7 12.66, 446.67 32 C449.39 166.97, 448.39 305.53, 446.67 424.67 C445.16 446.7, 434.16 459.3, 414.67 456.67 C304.44 458.17, 195.25 455.91, 32 456.67 C7.86 456.34, 0.85 446.45, 0 424.67 C4.53 318.09, 4.63 212.5, 0 32 C-0.81 12.36, 9.77 0.12, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C165.67 0.58, 300.66 0.36, 414.67 0 M32 0 C161.1 -1.74, 291.61 -1.96, 414.67 0 M414.67 0 C437.2 -1.51, 446.67 9.68, 446.67 32 M414.67 0 C437.89 -2.22, 448.67 8.68, 446.67 32 M446.67 32 C447.73 157.17, 446.57 282.51, 446.67 424.67 M446.67 32 C445.67 144.16, 445.95 256.73, 446.67 424.67 M446.67 424.67 C447.18 446.96, 436.76 456.14, 414.67 456.67 M446.67 424.67 C448.52 446.14, 433.99 456.81, 414.67 456.67 M414.67 456.67 C292.02 457.56, 167.19 457.67, 32 456.67 M414.67 456.67 C276.16 457.92, 138.53 458.18, 32 456.67 M32 456.67 C12.33 457.22, -0.64 447.73, 0 424.67 M32 456.67 C11.65 456.59, -1.2 448.19, 0 424.67 M0 424.67 C-0.68 282.02, -0.26 138.6, 0 32 M0 424.67 C-1.95 340.72, -2.41 255.66, 0 32 M0 32 C-0.1 12.55, 8.93 -1.93, 32 0 M0 32 C2.02 10.39, 11.66 0.2, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(1125.8659362792966 3627.5000000000036) rotate(0 214.13406372070312 135)"><text x="214.13406372070312" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">1. Modifies NodeRefs</text><text x="214.13406372070312" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">and DupCache, but not</text><text x="214.13406372070312" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Nodes</text><text x="214.13406372070312" y="166.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">2. Appends CreateNode</text><text x="214.13406372070312" y="211.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">in shard request to the</text><text x="214.13406372070312" y="256.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">OpLog table</text></g><g transform="translate(53.5357666015625 4321.6666666666715) rotate(0 762.2642822265625 45)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Now we have a Name in NodeRefs for this file and we have a CreateNode request in</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">the OpLog table. Time to create the node in the shard.</text></g><g stroke-linecap="round" transform="translate(158.82144165039085 4497.083333333347) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C149.24 4.34, 267.97 3.52, 423 0 C446.99 2.59, 454.53 11.43, 455 32 C451.99 86.92, 450.17 139.41, 455 256.33 C454.8 281.13, 442.85 285.23, 423 288.33 C296.8 292.3, 169.04 291.31, 32 288.33 C8.22 289.44, 0.11 279.84, 0 256.33 C-2.76 202.17, -1.2 143.85, 0 32 C-2.42 11.98, 11.81 -2.48, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C149.31 -1.5, 267.08 0.03, 423 0 M32 0 C143.85 1.81, 255.52 1.82, 423 0 M423 0 C442.81 -0.39, 453.17 12.58, 455 32 M423 0 C442.21 -1.98, 454.21 11.69, 455 32 M455 32 C454.69 84.96, 457.37 138.13, 455 256.33 M455 32 C456.41 81.53, 456.59 129.75, 455 256.33 M455 256.33 C456.03 278.69, 444.66 287.61, 423 288.33 M455 256.33 C454.06 277.64, 446.61 289.44, 423 288.33 M423 288.33 C276.11 290.93, 129.09 289.26, 32 288.33 M423 288.33 C343.56 287.35, 265.51 288.05, 32 288.33 M32 288.33 C12.14 289.6, -0.54 276.82, 0 256.33 M32 288.33 C9.54 286.98, 0.11 278.52, 0 256.33 M0 256.33 C-0.29 175.45, -0.08 93.55, 0 32 M0 256.33 C1.02 195.14, 0.86 132.68, 0 32 M0 32 C-0.82 9.52, 9.26 -1.72, 32 0 M0 32 C-1.1 8.52, 8.46 0.47, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(283.10940551757835 4618.750000000015) rotate(0 103.2120361328125 22.5)"><text x="103.2120361328125" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Main tablet</text></g><g stroke-linecap="round" transform="translate(345.4881083170578 4908.750000000007) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C180.29 0.04, 325.21 -1.03, 423 0 C442.31 -2.52, 458.23 9.99, 455 32 C452.14 103.76, 451.03 166.9, 455 256.33 C455.93 275.35, 447.35 290.36, 423 288.33 C294.23 288.1, 168.37 288.72, 32 288.33 C8.83 290.62, 0.82 277.03, 0 256.33 C-3.21 177.81, -0.14 94.89, 0 32 C-2.27 11.35, 12.17 1.66, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C131.53 -1.93, 230.44 -1.82, 423 0 M32 0 C147.37 -0.07, 263.09 0.6, 423 0 M423 0 C442.49 -1.72, 454.31 11.56, 455 32 M423 0 C442.91 1.37, 453.16 8.71, 455 32 M455 32 C454.94 94.84, 457.92 155.77, 455 256.33 M455 32 C456.2 122.11, 455.9 211.04, 455 256.33 M455 256.33 C454.18 277.64, 446.31 289.3, 423 288.33 M455 256.33 C456.74 275.55, 446.12 288.3, 423 288.33 M423 288.33 C276.72 287.29, 132.41 285.65, 32 288.33 M423 288.33 C331.54 289.99, 239.06 289.37, 32 288.33 M32 288.33 C9.69 287.15, 0.1 278.41, 0 256.33 M32 288.33 C12.08 288.61, 0.13 277.58, 0 256.33 M0 256.33 C-0.6 186.56, 0.74 118.79, 0 32 M0 256.33 C-1.78 177.13, -2.03 98.17, 0 32 M0 32 C-0.96 8.8, 8.75 0.41, 32 0 M0 32 C0.06 11.56, 9.11 -1.12, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(523.1640803019211 5030.416666666675) rotate(0 49.82402801513672 22.5)"><text x="49.82402801513672" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Shard</text></g><g stroke-linecap="round"><g transform="translate(386.6666666666665 4784.1666666666715) rotate(0 85.47860355050807 60.83333333333394)"><path d="M-0.51 -0.45 C27.86 20.01, 141.94 101.1, 170.65 121.57 M1.42 -1.72 C29.57 19.02, 141.21 102.69, 169.54 123.05" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(386.6666666666665 4784.1666666666715) rotate(0 85.47860355050807 60.83333333333394)"><path d="M145.55 116.01 C152.77 117.96, 161.38 122.15, 169.54 123.05 M145.55 116.01 C153.33 118.04, 163.12 119.97, 169.54 123.05" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(386.6666666666665 4784.1666666666715) rotate(0 85.47860355050807 60.83333333333394)"><path d="M155.69 102.24 C159.39 108.75, 164.6 117.55, 169.54 123.05 M155.69 102.24 C159.74 109.29, 165.88 116.16, 169.54 123.05" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(539.9999999999998 4820.833333333343) rotate(0 103.50602722167969 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">CreateNode</text></g><g transform="translate(54.40238444010447 5285.833333333336) rotate(0 717.332275390625 45)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">If CreateNode request succeeds in shard, main tablet removes the OpLog entry</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">and responds to the client.</text></g><g stroke-linecap="round" transform="translate(155.83333333333303 5463.333333333343) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C160.15 -1.95, 288.03 -2.37, 423 0 C447.71 -2.23, 454.47 11.44, 455 32 C453.13 97.64, 455.3 161.19, 455 256.33 C451.91 276.85, 447.39 288.19, 423 288.33 C311.78 284.94, 203.26 284.73, 32 288.33 C14.01 290.65, 0.76 280.69, 0 256.33 C-3.66 198.88, -0.84 139.48, 0 32 C3.08 8.85, 8.54 0.42, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C112.52 0.07, 194.08 -0.62, 423 0 M32 0 C135.1 -2.73, 238.08 -2.04, 423 0 M423 0 C443.54 -0.94, 456.77 12.18, 455 32 M423 0 C445.88 0.3, 454.93 11.07, 455 32 M455 32 C454.46 95.76, 453.73 160.44, 455 256.33 M455 32 C454.72 101.53, 455.67 170.31, 455 256.33 M455 256.33 C453.34 278.49, 442.58 288.14, 423 288.33 M455 256.33 C453.63 278.91, 446.09 287.61, 423 288.33 M423 288.33 C298.71 289.16, 175.47 287.51, 32 288.33 M423 288.33 C337.09 290.75, 252.1 289.96, 32 288.33 M32 288.33 C9.78 289.43, -0.43 275.83, 0 256.33 M32 288.33 C9.6 286.6, -1.51 276.99, 0 256.33 M0 256.33 C-1.83 211.81, -2.23 165.57, 0 32 M0 256.33 C-0.76 198.63, -0.85 141.79, 0 32 M0 32 C-1.75 9.71, 8.8 1.98, 32 0 M0 32 C1.03 11.16, 12.05 1.47, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(280.1212972005203 5585.000000000011) rotate(0 103.2120361328125 22.5)"><text x="103.2120361328125" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Main tablet</text></g><g stroke-linecap="round" transform="translate(937.5000000000002 5426.666666666668) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C180.15 -3.49, 324.07 -1.74, 423 0 C443.66 0.24, 457.57 8.23, 455 32 C452.43 116.8, 457.72 202.88, 455 256.33 C454.35 275.61, 442.51 286.74, 423 288.33 C332.43 286.68, 238.41 287.09, 32 288.33 C9.45 289.69, 0.91 274.93, 0 256.33 C2.13 171.13, -2.35 89.4, 0 32 C1.58 13.25, 12.3 -2.89, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C164.44 1.15, 298.86 0.96, 423 0 M32 0 C114.32 -0.95, 197.62 -0.24, 423 0 M423 0 C445.68 0.26, 454.94 11.02, 455 32 M423 0 C444.08 -2.18, 454.9 12.4, 455 32 M455 32 C455.79 84.9, 457.12 137.04, 455 256.33 M455 32 C455.68 103.79, 455.64 174.8, 455 256.33 M455 256.33 C453.81 278.74, 445.86 287.7, 423 288.33 M455 256.33 C455.36 277.05, 444.43 286.77, 423 288.33 M423 288.33 C280 286.99, 139.97 285.83, 32 288.33 M423 288.33 C284.09 286.82, 145.58 285.96, 32 288.33 M32 288.33 C9.74 286.82, -1.32 277.08, 0 256.33 M32 288.33 C8.43 289.63, 0.04 276.68, 0 256.33 M0 256.33 C0.54 176.93, 1.76 96.28, 0 32 M0 256.33 C-1.53 188.7, -1.58 122.75, 0 32 M0 32 C0.89 11.1, 11.87 1.28, 32 0 M0 32 C0.61 11.9, 12.63 0.54, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(957.8639526367188 5503.333333333336) rotate(0 207.13604736328125 67.5)"><text x="207.13604736328125" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">1. Removes OpLog entry</text><text x="207.13604736328125" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">2. Patches DupCache</text><text x="207.13604736328125" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">entry</text></g><g stroke-linecap="round"><g transform="translate(613.6785583496085 5602.083333333339) rotate(0 160.45238749186387 -24.537530339055593)"><path d="M0.53 -1.07 C54.03 -9.38, 268.38 -40.62, 321.7 -48.72 M-0.65 0.99 C52.69 -7.19, 267.82 -42.38, 321.17 -50.65" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(613.6785583496085 5602.083333333339) rotate(0 160.45238749186387 -24.537530339055593)"><path d="M299.32 -38.5 C305.3 -41.66, 315.56 -48.15, 321.17 -50.65 M299.32 -38.5 C305.41 -41.61, 310.23 -44.64, 321.17 -50.65" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(613.6785583496085 5602.083333333339) rotate(0 160.45238749186387 -24.537530339055593)"><path d="M296.62 -55.39 C303.74 -52.47, 314.97 -52.87, 321.17 -50.65 M296.62 -55.39 C303.54 -54.25, 309.04 -53.01, 321.17 -50.65" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(671.6666666666665 5502.500000000007) rotate(0 104.32603454589844 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">LocalDB tx</text></g><g stroke-linecap="round" transform="translate(144.1666666666663 5915) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C135.75 -3.56, 236.5 -3.09, 423 0 C445.33 2.04, 454.87 12.34, 455 32 C452.66 99.84, 449.43 173.24, 455 256.33 C457.34 278.28, 441.85 286.2, 423 288.33 C321.46 283.83, 220.83 287.5, 32 288.33 C7.26 290.21, 0.6 278.78, 0 256.33 C1.09 195.01, 0.51 131.66, 0 32 C1.05 7.36, 13.61 0.72, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C112.72 -0.97, 192.45 0.17, 423 0 M32 0 C160.4 -0.73, 288.46 -0.24, 423 0 M423 0 C442.66 -0.96, 455.8 8.99, 455 32 M423 0 C445.27 -0.96, 456.05 12.02, 455 32 M455 32 C455.92 90.23, 455.49 146.8, 455 256.33 M455 32 C456.89 101.65, 455.43 171.35, 455 256.33 M455 256.33 C456.76 279.13, 446.17 288.76, 423 288.33 M455 256.33 C454.56 279.45, 442.11 289.9, 423 288.33 M423 288.33 C336.35 286.1, 248.44 286.96, 32 288.33 M423 288.33 C302.71 286.98, 183.65 287.73, 32 288.33 M32 288.33 C10.96 289.25, -1.43 276, 0 256.33 M32 288.33 C10.6 287.25, 0.85 276.11, 0 256.33 M0 256.33 C1.92 183.16, -0.28 113.71, 0 32 M0 256.33 C-2.2 206.83, -1.17 156.26, 0 32 M0 32 C-1.59 9.73, 9.16 -0.69, 32 0 M0 32 C0.68 12.14, 12.19 -0.5, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(176.24456278483035 6036.666666666668) rotate(0 195.42210388183594 22.5)"><text x="195.42210388183594" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">TStorageServiceActor</text></g><g stroke-linecap="round"><g transform="translate(379.9999999999998 5750.833333333339) rotate(0 -12.5 85)"><path d="M0.44 -0.98 C-3.83 27.54, -21.72 142.32, -25.85 170.88 M-0.79 1.12 C-4.67 29.33, -19.6 141.36, -23.59 169.21" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(379.9999999999998 5750.833333333339) rotate(0 -12.5 85)"><path d="M-28.86 144.77 C-29.05 150.21, -24.48 159.6, -23.59 169.21 M-28.86 144.77 C-27.82 152.66, -24.69 160.97, -23.59 169.21" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(379.9999999999998 5750.833333333339) rotate(0 -12.5 85)"><path d="M-11.92 147.11 C-16.87 151.94, -17.07 160.68, -23.59 169.21 M-11.92 147.11 C-16.49 154.27, -18.98 161.81, -23.59 169.21" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(399.9999999999998 5807.500000000007) rotate(0 182.2020263671875 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">CreateNodeResponse</text></g><g transform="translate(34.33439127604106 6265.833333333343) rotate(0 823.7882690429688 67.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">If CreateNode in shard request fails, it's retried until it succeeds. If main tablet reboots,</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">it reads OpLog into its memory and again retries all shard requests until they</text><text x="0" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">succeed.</text></g><g transform="translate(29.302637736002453 6443.333333333343) rotate(0 413.838134765625 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1971c2" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Node creation: special case - hardlink creation</text></g><g transform="translate(41.88047281901072 6528.333333333336) rotate(0 784.0982666015625 202.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Hardlinks are pretty rare and we took a simplified non-transactional approach to their</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">implementation in a sharded filesystem. And added a TODO to make a proper</text><text x="0" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">implementation =)</text><text x="0" y="166.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"></text><text x="0" y="211.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Hardlink creation involves multiple steps which are performed in TStorageServiceActor,</text><text x="0" y="256.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">not in the main tablet =&gt; no transaction. The drawback here is that in rare cases</text><text x="0" y="301.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">we can leave garbage hardlinks which are invisible to the user but which prevent</text><text x="0" y="346.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">actual inode deletion and thus some free space may become lost (until we manually call</text><text x="0" y="391.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">filestore-client findgarbage).</text></g><g stroke-linecap="round" transform="translate(109.16666666666652 7020.833333333347) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C119.29 0.38, 208.16 -1.04, 423 0 C442.21 2.39, 456.97 9.42, 455 32 C455.34 91.22, 451.71 147.04, 455 256.33 C455.07 281.19, 444.57 289.1, 423 288.33 C283.21 284.52, 147.52 285.04, 32 288.33 C10.65 287.7, 1.26 276.58, 0 256.33 C-2.07 212.19, -5.48 167.6, 0 32 C-2.78 10.04, 9.6 -3.39, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C163.68 -0.93, 294.21 -0.11, 423 0 M32 0 C156.36 0.91, 280.24 1.43, 423 0 M423 0 C443.66 1.19, 455.78 11.76, 455 32 M423 0 C446.53 -1.47, 452.94 9.1, 455 32 M455 32 C456.12 86.76, 456.07 142.8, 455 256.33 M455 32 C454.71 107.21, 455.29 181.35, 455 256.33 M455 256.33 C456.28 279.05, 442.62 287.95, 423 288.33 M455 256.33 C456.28 276.31, 442.52 288.04, 423 288.33 M423 288.33 C317.67 289.02, 212.04 289.79, 32 288.33 M423 288.33 C339.63 289.76, 257.11 290.12, 32 288.33 M32 288.33 C10.94 290.02, 0.44 278.57, 0 256.33 M32 288.33 C8.41 289.08, -0.2 277.58, 0 256.33 M0 256.33 C0.62 166.51, 1.74 77.5, 0 32 M0 256.33 C-0.12 196.98, 0.67 136.99, 0 32 M0 32 C-0.51 11.39, 10.8 -1.56, 32 0 M0 32 C-0.43 12.1, 12.67 -1.8, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(141.24456278483058 7142.500000000015) rotate(0 195.42210388183594 22.5)"><text x="195.42210388183594" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">TStorageServiceActor</text></g><g stroke-linecap="round"><g transform="translate(566.6666666666665 7164.1666666666715) rotate(0 195 1.8189894035458565e-12)"><path d="M-0.39 0.7 C64.8 0.62, 325.7 0.18, 390.87 0.12 M1.61 0.03 C66.73 0.11, 325.62 1.42, 390.38 1.72" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(566.6666666666665 7164.1666666666715) rotate(0 195 1.8189894035458565e-12)"><path d="M366.84 10.16 C374.61 9.3, 380.27 6.48, 390.38 1.72 M366.84 10.16 C374.05 7.24, 382.77 3.93, 390.38 1.72" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(566.6666666666665 7164.1666666666715) rotate(0 195 1.8189894035458565e-12)"><path d="M366.93 -6.94 C374.75 -2.98, 380.39 -0.98, 390.38 1.72 M366.93 -6.94 C374.09 -4.26, 382.79 -1.96, 390.38 1.72" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(638.333333333333 7074.1666666666715) rotate(0 127.10203552246094 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">creates actor</text></g><g stroke-linecap="round" transform="translate(961.6666666666665 7012.500000000007) rotate(0 233.33333333333326 153.33333333333394)"><path d="M32 0 C150.5 0.96, 265.79 -0.57, 434.67 0 C459.41 -0.42, 467.51 13, 466.67 32 C466.11 85.23, 463.05 139.65, 466.67 274.67 C464.74 294.45, 454.69 304.48, 434.67 306.67 C282.19 305.49, 128.55 304.57, 32 306.67 C11.93 307.68, -0.36 298.18, 0 274.67 C3.44 207.63, 1.76 145.38, 0 32 C1.77 14.01, 13.65 1, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C131.59 -0.63, 233.19 -1.33, 434.67 0 M32 0 C172.31 1.27, 311.97 1.21, 434.67 0 M434.67 0 C454.43 0.82, 467.63 8.75, 466.67 32 M434.67 0 C455.79 0.29, 467.78 11.2, 466.67 32 M466.67 32 C467.37 95.04, 468.36 155.19, 466.67 274.67 M466.67 32 C467.63 106.96, 467.69 181.57, 466.67 274.67 M466.67 274.67 C467.62 297.36, 456.58 306.09, 434.67 306.67 M466.67 274.67 C464.46 295.81, 458.01 306.16, 434.67 306.67 M434.67 306.67 C338.46 306.77, 244.2 307.27, 32 306.67 M434.67 306.67 C280.89 307.52, 126.33 307.68, 32 306.67 M32 306.67 C10.25 307.76, 1.23 297.56, 0 274.67 M32 306.67 C12.96 305.34, -1.69 296.82, 0 274.67 M0 274.67 C-1.36 219.8, 0.77 162.54, 0 32 M0 274.67 C-1.48 200.7, -1.36 125.44, 0 32 M0 32 C-0.46 9.91, 10.78 -1.33, 32 0 M0 32 C1.63 11.5, 11.29 1.03, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(1098.1459579467771 7143.333333333339) rotate(0 96.85404205322266 22.5)"><text x="96.85404205322266" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">TLinkActor</text></g><g stroke-linecap="round" transform="translate(119.99999999999955 7512.499999999996) rotate(0 233.33333333333326 153.33333333333394)"><path d="M32 0 C132.74 -2.03, 231.8 -1.49, 434.67 0 C456.88 2.68, 467.57 7.51, 466.67 32 C462.75 97.29, 468.12 164.15, 466.67 274.67 C465.85 296.75, 456.74 305.42, 434.67 306.67 C316.03 308.47, 194.87 307.24, 32 306.67 C12.52 304.22, -2.18 296.54, 0 274.67 C-0.42 214.16, 1.87 153.21, 0 32 C1.73 12.79, 8.27 -2.21, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C136.86 -0.48, 239.79 0.97, 434.67 0 M32 0 C142.14 1.32, 251.8 1.78, 434.67 0 M434.67 0 C457.26 -0.25, 468.1 12.14, 466.67 32 M434.67 0 C456.63 2.06, 464.87 11.03, 466.67 32 M466.67 32 C465.94 108.97, 465 188.18, 466.67 274.67 M466.67 32 C466.26 122.38, 466.37 210.96, 466.67 274.67 M466.67 274.67 C466.17 295.01, 457.44 306.76, 434.67 306.67 M466.67 274.67 C465.41 297.08, 457.13 307.93, 434.67 306.67 M434.67 306.67 C345.34 304.76, 256.87 304.32, 32 306.67 M434.67 306.67 C346.66 305.91, 258.52 305.96, 32 306.67 M32 306.67 C11.44 308.65, -1.66 294.68, 0 274.67 M32 306.67 C8.38 306.74, -2.07 294.29, 0 274.67 M0 274.67 C0.47 188.81, 0.61 101.92, 0 32 M0 274.67 C0.38 177.66, -0.62 82.43, 0 32 M0 32 C1.71 9.7, 10.83 -1.87, 32 0 M0 32 C0.01 9.34, 9.52 1.55, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(256.47929128011015 7643.3333333333285) rotate(0 96.85404205322266 22.5)"><text x="96.85404205322266" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">TLinkActor</text></g><g stroke-linecap="round"><g transform="translate(587.6666666666661 7678.805925432625) rotate(0 231.16666666666674 -14.606915316506274)"><path d="M0.69 -0.12 C77.61 -5.09, 384.27 -24.29, 461.27 -29.32 M-0.41 -1.22 C76.89 -6.05, 386.33 -23.11, 463.42 -27.84" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(587.6666666666661 7678.805925432625) rotate(0 231.16666666666674 -14.606915316506274)"><path d="M440.46 -17.95 C446.61 -22.61, 453 -23, 463.42 -27.84 M440.46 -17.95 C445.91 -20.63, 449.16 -21.65, 463.42 -27.84" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(587.6666666666661 7678.805925432625) rotate(0 231.16666666666674 -14.606915316506274)"><path d="M439.47 -35.02 C445.97 -34.94, 452.64 -30.58, 463.42 -27.84 M439.47 -35.02 C445.21 -34.17, 448.66 -31.66, 463.42 -27.84" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(1053.3333333333335 7512.500000000011) rotate(0 233.33333333333326 153.33333333333394)"><path d="M32 0 C135.73 -3.28, 235.92 -1.58, 434.67 0 C457.92 0.85, 464.87 13, 466.67 32 C465.87 92.1, 463.23 154.82, 466.67 274.67 C469.09 298.8, 455.42 305.68, 434.67 306.67 C303.41 309.37, 170.13 308.21, 32 306.67 C12.5 306.22, 0.25 296.59, 0 274.67 C1.63 185.55, -1.97 101.38, 0 32 C2.55 10.81, 13.33 2.24, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C174.44 0.97, 317.65 1.94, 434.67 0 M32 0 C182.11 2.03, 332.6 1.71, 434.67 0 M434.67 0 C454.41 1.13, 465.84 11.32, 466.67 32 M434.67 0 C457.15 1.67, 468.55 10.2, 466.67 32 M466.67 32 C467.47 117.22, 467 202.96, 466.67 274.67 M466.67 32 C466.3 127.53, 467.82 225.18, 466.67 274.67 M466.67 274.67 C465.99 295.26, 456.42 305.65, 434.67 306.67 M466.67 274.67 C467.6 294.15, 457.02 306.96, 434.67 306.67 M434.67 306.67 C351.61 307.94, 270.56 308.11, 32 306.67 M434.67 306.67 C300.14 307.68, 165.62 308.18, 32 306.67 M32 306.67 C12.32 307.68, -1.96 295.98, 0 274.67 M32 306.67 C12.87 307.67, 1.46 295.07, 0 274.67 M0 274.67 C2.68 178.59, 2.8 82.75, 0 32 M0 274.67 C-0.93 218.55, -1.34 162.41, 0 32 M0 32 C1.01 12.49, 9.55 0.44, 32 0 M0 32 C-1.47 10.33, 9.59 -0.07, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(1103.2226053873699 7575.833333333347) rotate(0 183.44406127929688 90)"><text x="183.44406127929688" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Shard (id=ShardId)</text><text x="183.44406127929688" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">guid1 -&gt; target inode</text><text x="183.44406127929688" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">guid2 -&gt; hardlink -&gt;</text><text x="183.44406127929688" y="166.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">target inode</text></g><g transform="translate(613.333333333333 7580.833333333339) rotate(0 200.9220428466797 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">1. CreateNode in shard</text></g><g stroke-linecap="round"><g transform="translate(346.95702254160915 7820.166666666664) rotate(0 236.52148872919497 168.28668248834038)"><path d="M1.03 -0.33 C79.54 55.72, 393.13 279.63, 471.94 335.97 M0.1 -1.55 C78.9 54.68, 395.17 280.95, 474.07 337.19" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(346.95702254160915 7820.166666666664) rotate(0 236.52148872919497 168.28668248834038)"><path d="M449.98 330.49 C458.33 330.93, 466.8 336.59, 474.07 337.19 M449.98 330.49 C459.12 333.66, 469.04 334.64, 474.07 337.19" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(346.95702254160915 7820.166666666664) rotate(0 236.52148872919497 168.28668248834038)"><path d="M459.92 316.58 C464.55 322.25, 469.34 333.07, 474.07 337.19 M459.92 316.58 C465.14 325.26, 471.18 331.68, 474.07 337.19" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g stroke-linecap="round" transform="translate(829.9999999999995 8047.500000000004) rotate(0 304.16666666666674 153.33333333333394)"><path d="M32 0 C195.01 -4.72, 357.73 -2.86, 576.33 0 C595.44 -0.66, 605.89 14.11, 608.33 32 C609.19 126.93, 608.8 218.93, 608.33 274.67 C606.29 297.78, 600.73 307.11, 576.33 306.67 C390.61 308.99, 203.61 309.15, 32 306.67 C9.54 305.92, 0.09 296.58, 0 274.67 C0.83 196.12, 3.38 114.02, 0 32 C-1.56 9.67, 10.67 -2.73, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C249.89 0.91, 466.64 0.16, 576.33 0 M32 0 C235.46 -1.71, 438.95 -2.15, 576.33 0 M576.33 0 C597.96 -0.98, 608.89 9.68, 608.33 32 M576.33 0 C597.22 1.21, 609.25 9.54, 608.33 32 M608.33 32 C607.06 123.03, 607.13 212.04, 608.33 274.67 M608.33 32 C609.23 92.72, 610.28 152.23, 608.33 274.67 M608.33 274.67 C608.04 294.32, 596 308.5, 576.33 306.67 M608.33 274.67 C606.23 293.7, 599.16 305.66, 576.33 306.67 M576.33 306.67 C414.88 306.09, 252.46 305.6, 32 306.67 M576.33 306.67 C452.42 304.88, 327.7 304.91, 32 306.67 M32 306.67 C11.46 308.61, -1.75 294.39, 0 274.67 M32 306.67 C12.78 308.2, 0.5 294.16, 0 274.67 M0 274.67 C1.23 212.12, 1.72 147.26, 0 32 M0 274.67 C-1.66 216.04, -1.22 156.52, 0 32 M0 32 C0.39 11.98, 8.72 1.12, 32 0 M0 32 C-0.05 11.55, 10.48 -2.07, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(873.48057047526 8155.833333333339) rotate(0 260.68609619140625 45)"><text x="260.68609619140625" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Main tablet</text><text x="260.68609619140625" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">link name -&gt; {ShardId, guid2}</text></g><g transform="translate(545.5173085530598 7881.6666666666715) rotate(0 522.1221008300781 45)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">2. CreateNode in main tablet, ShardId and guid2</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">                are passed in the request</text></g><g transform="translate(73.33333333333303 8419.166666666672) rotate(0 729.1442260742188 135)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Notes:</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">* ShardId is selected by TStorageServiceActor to be the same as the id of the</text><text x="0" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    shard that holds the target inode</text><text x="0" y="166.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">* ShardName is generated by TLinkActor and passed to the main tablet</text><text x="0" y="211.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">* If TStorageServiceActor or main tablet go down before step 2 is done, target</text><text x="0" y="256.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    inode will never get to RefCount==0 without manual intervention</text></g><g transform="translate(52.60772705078125 8863.750000000011) rotate(0 763.5783081054688 135)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">RenameNode is a simple main tablet-only operation in most of the cases - unless the</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">target Name is already occupied. In that case RenameNode op needs to decrease</text><text x="0" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">RefCount of the inode that was referenced by that name and, in most of the cases,</text><text x="0" y="166.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">that inode's RefCount goes to 0 and, thus, that inode needs to be deleted. In this</text><text x="0" y="211.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">case RenameNode actually works in a similar way to UnlinkNode, so I'll focus only on</text><text x="0" y="256.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">UnlinkNode here.</text></g><g transform="translate(45.94106038411519 8767.916666666668) rotate(0 164.52206420898438 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1971c2" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Node unlink/rename</text></g><g stroke-linecap="round" transform="translate(51.18454996744822 9191.666666666679) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C124.59 -1.13, 220.47 -1.16, 423 0 C443.82 2.91, 454.08 10.79, 455 32 C458.27 94.79, 456.45 161.28, 455 256.33 C458.25 280.75, 443.63 287.15, 423 288.33 C303.79 293.74, 182.73 291.84, 32 288.33 C11.62 284.9, -2.98 275.67, 0 256.33 C-0.54 191.41, -0.13 129.35, 0 32 C-0.04 10.18, 8.39 -0.28, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C141.49 1.13, 249.32 0.56, 423 0 M32 0 C172.75 0.16, 312.05 -0.39, 423 0 M423 0 C446.07 -0.38, 456.84 11.88, 455 32 M423 0 C444.84 0.56, 453.05 12.28, 455 32 M455 32 C455.43 95.33, 453.92 160.03, 455 256.33 M455 32 C453.79 103.7, 454.11 177.24, 455 256.33 M455 256.33 C456.02 276.3, 445.66 288.06, 423 288.33 M455 256.33 C454.56 277.54, 445.73 289.11, 423 288.33 M423 288.33 C283.54 289.12, 146.82 289.59, 32 288.33 M423 288.33 C316.2 287.14, 209.24 287.18, 32 288.33 M32 288.33 C10.69 288.66, -1.56 275.85, 0 256.33 M32 288.33 C9.24 289.23, 1.07 275.59, 0 256.33 M0 256.33 C2.21 202.22, 1.68 152.45, 0 32 M0 256.33 C0.54 180.37, 0.35 104.51, 0 32 M0 32 C-0.05 9.5, 9.28 1.39, 32 0 M0 32 C0.25 11.75, 9.97 1.22, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(83.26244608561228 9313.333333333347) rotate(0 195.42210388183594 22.5)"><text x="195.42210388183594" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">TStorageServiceActor</text></g><g stroke-linecap="round" transform="translate(810.3512166341152 9180.833333333336) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C186.62 -2.18, 341.29 -3.81, 423 0 C443.88 2.82, 454.38 11.32, 455 32 C456.37 89.83, 452.97 141.34, 455 256.33 C455.26 276.57, 447.39 289.91, 423 288.33 C270.15 286.39, 114.45 287.23, 32 288.33 C10.24 286.16, -3.51 274.6, 0 256.33 C2.46 190.64, 0.55 125.55, 0 32 C2.49 7.6, 13.16 -1.7, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C146.07 0.2, 258.73 2.27, 423 0 M32 0 C155.24 1.75, 278 2.21, 423 0 M423 0 C444.77 0.49, 453.31 12.07, 455 32 M423 0 C443.93 -1.19, 453.43 12.57, 455 32 M455 32 C455.3 98.42, 453.98 166.45, 455 256.33 M455 32 C455.82 77.45, 455.96 123.96, 455 256.33 M455 256.33 C454.62 277.56, 445.55 289.01, 423 288.33 M455 256.33 C456.24 277.09, 444.69 286.12, 423 288.33 M423 288.33 C290.66 291.11, 158.45 290.49, 32 288.33 M423 288.33 C321.58 287.69, 219.69 287.06, 32 288.33 M32 288.33 C9.42 289.11, 0.93 275.86, 0 256.33 M32 288.33 C9.18 287.42, -2.08 279.6, 0 256.33 M0 256.33 C-0.38 206, -0.53 156.58, 0 32 M0 256.33 C0.92 197.03, 0.34 139.34, 0 32 M0 32 C0.21 11.61, 10.06 1.06, 32 0 M0 32 C-1.4 11.59, 12.43 -1, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(934.6391805013027 9302.500000000004) rotate(0 103.2120361328125 22.5)"><text x="103.2120361328125" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Main tablet</text></g><g stroke-linecap="round"><g transform="translate(506.1845499674482 9331.666666666679) rotate(0 149.9999999999999 0)"><path d="M-0.21 -0.62 C49.82 -0.6, 249.15 0.9, 299.18 0.99 M-1.78 1.67 C48.72 1.3, 251.29 -0.53, 301.46 -0.61" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(506.1845499674482 9331.666666666679) rotate(0 149.9999999999999 0)"><path d="M278.02 8.08 C281.98 4.89, 289.72 4.39, 301.46 -0.61 M278.02 8.08 C284.31 4.93, 291.61 1.95, 301.46 -0.61" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(506.1845499674482 9331.666666666679) rotate(0 149.9999999999999 0)"><path d="M277.92 -9.02 C282.02 -8.53, 289.78 -5.35, 301.46 -0.61 M277.92 -9.02 C284.38 -7.13, 291.7 -5.06, 301.46 -0.61" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(572.8512166341143 9248.33333333335) rotate(0 89.91203308105469 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">UnlinkNode</text></g><g transform="translate(46.184549967447765 9591.666666666679) rotate(0 792.3602294921875 112.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Once again, if DirectoryCreationInShardsEnabled flag is on, main tablet role is taken</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">by the shard that is in charge of the parent directory.</text><text x="0" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"></text><text x="0" y="166.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Unlike CreateNode, no shard balancing should be done - the shard that takes</text><text x="0" y="211.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">part in the operation is the shard that holds the inode referenced by the unlinked name.</text></g><g stroke-linecap="round" transform="translate(38.82743326823038 9905.833333333347) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C187.56 1.11, 342.63 -1.09, 423 0 C443.72 -1.79, 456.4 9.5, 455 32 C454.39 120.43, 450.06 211.02, 455 256.33 C451.85 278.87, 446.07 290.59, 423 288.33 C306.82 287.46, 190.3 289.77, 32 288.33 C8.39 285.07, -0.71 275.13, 0 256.33 C-3.35 191.2, -2.18 131.61, 0 32 C0.69 7.27, 7.81 2.21, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C161.91 -0.88, 292.78 -1.8, 423 0 M32 0 C114.1 -1.41, 195.28 -1.12, 423 0 M423 0 C442.53 1.69, 453.43 11.73, 455 32 M423 0 C446.53 0.86, 454.08 11.32, 455 32 M455 32 C453.2 93.22, 453.27 153.33, 455 256.33 M455 32 C454.95 115.36, 454.68 198.14, 455 256.33 M455 256.33 C456.53 276.79, 446.26 289.72, 423 288.33 M455 256.33 C457.18 277.34, 446.19 287.74, 423 288.33 M423 288.33 C304.21 290.32, 185.19 289.64, 32 288.33 M423 288.33 C301.03 290.09, 179.34 290.1, 32 288.33 M32 288.33 C12.36 289.21, 1.85 277.66, 0 256.33 M32 288.33 C10.7 288.94, -2.19 275.76, 0 256.33 M0 256.33 C-1.45 200.03, 0.07 145.42, 0 32 M0 256.33 C-0.52 172.21, 0.62 87.49, 0 32 M0 32 C1.38 9.72, 12.35 0.11, 32 0 M0 32 C-0.83 12.8, 10.4 1.78, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(163.11539713541788 10027.500000000015) rotate(0 103.2120361328125 22.5)"><text x="103.2120361328125" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Main tablet</text></g><g stroke-linecap="round" transform="translate(225.49409993489644 10315.833333333347) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C178.57 0.16, 326.65 0.52, 423 0 C447.91 -3.52, 452.91 13.91, 455 32 C450.56 91.73, 454.76 151.33, 455 256.33 C454.82 276.5, 443.88 286.93, 423 288.33 C310.9 290.27, 201.04 290.69, 32 288.33 C9.88 291.6, 0.35 277.43, 0 256.33 C-0.49 205.76, -3.54 162.92, 0 32 C2.78 9.33, 8.32 2.48, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C148.69 1.05, 267.94 2.31, 423 0 M32 0 C113.5 1.39, 195.59 1.21, 423 0 M423 0 C446.24 0.74, 454.2 11.24, 455 32 M423 0 C443.71 -0.87, 453.88 9.23, 455 32 M455 32 C455.07 98.97, 454.69 165.06, 455 256.33 M455 32 C454.49 110.86, 454.65 191.08, 455 256.33 M455 256.33 C456.89 277.38, 445.95 287.82, 423 288.33 M455 256.33 C455.08 277.38, 446.13 287.94, 423 288.33 M423 288.33 C298.79 288.45, 175.31 287.18, 32 288.33 M423 288.33 C319.1 287.9, 214.74 287.64, 32 288.33 M32 288.33 C10.69 288.86, -1.9 276.01, 0 256.33 M32 288.33 C9.39 288.06, -1.39 275.42, 0 256.33 M0 256.33 C1.46 208.14, -0.06 158.9, 0 32 M0 256.33 C-0.74 190.35, -0.61 125.21, 0 32 M0 32 C-0.72 12.52, 10.43 1.54, 32 0 M0 32 C2.2 12.67, 10.94 0.86, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(403.1700719197597 10437.500000000015) rotate(0 49.82402801513672 22.5)"><text x="49.82402801513672" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Shard</text></g><g stroke-linecap="round"><g transform="translate(501.1845499674482 10043.333333333347) rotate(0 241.66666666666663 -1.6666666666660603)"><path d="M-0.78 -0.48 C79.5 -0.68, 401.72 -1.95, 482.25 -2.32 M1.01 -1.77 C81.61 -2.2, 403.76 -3.43, 484.39 -3.91" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(501.1845499674482 10043.333333333347) rotate(0 241.66666666666663 -1.6666666666660603)"><path d="M460.94 4.75 C468.35 0.09, 478.95 -2.67, 484.39 -3.91 M460.94 4.75 C468.74 1.89, 477.15 -1.83, 484.39 -3.91" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(501.1845499674482 10043.333333333347) rotate(0 241.66666666666663 -1.6666666666660603)"><path d="M460.86 -12.35 C468.14 -11.08, 478.77 -7.93, 484.39 -3.91 M460.86 -12.35 C468.85 -9.17, 477.29 -6.86, 484.39 -3.91" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(529.5178833007812 9958.333333333347) rotate(0 202.08407592773438 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">LocalDB UnlinkNode tx</text></g><g stroke-linecap="round" transform="translate(987.8512166341147 9888.333333333347) rotate(0 223.33333333333326 228.33333333333212)"><path d="M32 0 C181.13 0.18, 331.27 3.08, 414.67 0 C438.26 -0.18, 445.5 10.21, 446.67 32 C447.94 133.19, 444.09 236.59, 446.67 424.67 C444.13 445.22, 439.26 457.02, 414.67 456.67 C302.51 458.36, 188.15 456.25, 32 456.67 C12.88 459.44, -1.34 443.65, 0 424.67 C-4.36 279.89, -1.96 136.79, 0 32 C-1.14 11.7, 13.72 2.09, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C112.88 2.93, 192.94 1.32, 414.67 0 M32 0 C157.45 0.49, 283.46 0.52, 414.67 0 M414.67 0 C434.61 1.39, 446.88 11.61, 446.67 32 M414.67 0 C435.31 1.22, 445.27 11.59, 446.67 32 M446.67 32 C446.48 181.02, 445.51 328.79, 446.67 424.67 M446.67 32 C447.19 139.62, 446.85 247.12, 446.67 424.67 M446.67 424.67 C445.85 446.23, 437.8 458.38, 414.67 456.67 M446.67 424.67 C446.22 445.24, 436.17 455.97, 414.67 456.67 M414.67 456.67 C267.37 458.79, 120.4 457.64, 32 456.67 M414.67 456.67 C331.2 455.82, 247.94 456.34, 32 456.67 M32 456.67 C9.23 458.16, -0.02 445.73, 0 424.67 M32 456.67 C9.21 456.49, 1.59 444.04, 0 424.67 M0 424.67 C1.14 279.29, 2.14 134.61, 0 32 M0 424.67 C-2.11 276.77, -1.74 128.73, 0 32 M0 32 C-0.59 10.33, 9.67 0.78, 32 0 M0 32 C-0.75 12.95, 8.42 -1.33, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(996.4125010172527 9981.666666666679) rotate(0 214.7720489501953 135)"><text x="214.7720489501953" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">1. Modifies NodeRefs</text><text x="214.7720489501953" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">and DupCache, but not</text><text x="214.7720489501953" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Nodes</text><text x="214.7720489501953" y="166.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">2. Appends UnlinkNode in</text><text x="214.7720489501953" y="211.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">shard request to the</text><text x="214.7720489501953" y="256.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">OpLog table</text></g><g transform="translate(43.05364990234375 10659.166666666679) rotate(0 807.4803466796875 67.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Name is deleted from the main tablet's NodeRefs. Now we need to attempt UnlinkNode</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">request in the shard until it completes successfully. Just like in the CreateNode scenario.</text><text x="0" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"></text></g><g stroke-linecap="round" transform="translate(148.33932495117188 10834.58333333335) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C167.48 -0.06, 303.51 -0.15, 423 0 C440.95 3.37, 452.73 7.4, 455 32 C455.36 95.16, 452.35 155.01, 455 256.33 C456.13 277.82, 445.02 284.93, 423 288.33 C335.9 290.13, 251.8 293.03, 32 288.33 C11.7 285.99, 0.1 279.47, 0 256.33 C3.72 171.49, 0.14 83.08, 0 32 C-0.29 7.28, 12.67 -1.31, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C133.24 0.04, 234.63 0.59, 423 0 M32 0 C126.52 -1.31, 220.74 -1.27, 423 0 M423 0 C443.12 0.8, 456.53 9.79, 455 32 M423 0 C446.55 1.6, 457.18 10.34, 455 32 M455 32 C454.29 118.79, 454.21 203.21, 455 256.33 M455 32 C454.99 87.91, 454.04 142.07, 455 256.33 M455 256.33 C455.14 277.06, 446.03 289.21, 423 288.33 M455 256.33 C457.12 277.66, 444.36 288.94, 423 288.33 M423 288.33 C342.8 286.37, 261.75 286.08, 32 288.33 M423 288.33 C309.22 289.95, 195.09 289.99, 32 288.33 M32 288.33 C12.05 286.63, 1.38 276.72, 0 256.33 M32 288.33 C12.6 288.46, -0.83 279.8, 0 256.33 M0 256.33 C0.01 191.86, -0.84 128.29, 0 32 M0 256.33 C0.14 177.83, 0.29 99.52, 0 32 M0 32 C-1.96 9.51, 12.47 -0.77, 32 0 M0 32 C-1.15 10.51, 8.66 0.77, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(272.6272888183594 10956.250000000018) rotate(0 103.2120361328125 22.5)"><text x="103.2120361328125" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Main tablet</text></g><g stroke-linecap="round" transform="translate(335.00599161783884 11246.250000000007) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C142.37 2.64, 255.35 -1.22, 423 0 C443.62 -2.54, 454.22 13.93, 455 32 C455.74 101.63, 455.36 168.09, 455 256.33 C452.15 279.88, 447.11 286.99, 423 288.33 C331.81 289.98, 239.47 292.39, 32 288.33 C13.77 287.2, 1.04 280.72, 0 256.33 C0.83 173.07, 2.8 94.51, 0 32 C0.75 8.15, 11.9 1.74, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C129.55 -0.76, 229.26 0.18, 423 0 M32 0 C167.44 -0.98, 304.03 -1.46, 423 0 M423 0 C446.26 1.39, 456.89 10.38, 455 32 M423 0 C446.19 -0.59, 455.08 10.38, 455 32 M455 32 C453.74 116.15, 454.87 203.25, 455 256.33 M455 32 C454.68 118.26, 455.35 205.42, 455 256.33 M455 256.33 C456.85 277.66, 444.36 288.86, 423 288.33 M455 256.33 C452.81 275.76, 443.06 288.06, 423 288.33 M423 288.33 C329.22 285.56, 236.51 286.38, 32 288.33 M423 288.33 C311.44 287.66, 199.48 287.88, 32 288.33 M32 288.33 C12.35 288.44, -0.72 279.52, 0 256.33 M32 288.33 C10.4 290.11, 2.2 279.67, 0 256.33 M0 256.33 C0.16 185.9, -1.01 115.62, 0 32 M0 256.33 C-0.21 179.83, 1.4 104, 0 32 M0 32 C-1 10.53, 8.92 0.67, 32 0 M0 32 C1.11 12.11, 10.55 -0.75, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(512.6819636027021 11367.916666666675) rotate(0 49.82402801513672 22.5)"><text x="49.82402801513672" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Shard</text></g><g stroke-linecap="round"><g transform="translate(376.1845499674482 11121.666666666679) rotate(0 85.47860355050807 60.83333333333394)"><path d="M0.13 0.57 C28.7 20.81, 142.25 102.04, 170.6 122.31 M-1.26 -0.18 C27.19 19.64, 140.46 100.48, 169.46 120.52" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(376.1845499674482 11121.666666666679) rotate(0 85.47860355050807 60.83333333333394)"><path d="M145.32 113.99 C151.88 114.87, 157.56 115.76, 169.46 120.52 M145.32 113.99 C154.54 117.01, 162.73 118.39, 169.46 120.52" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(376.1845499674482 11121.666666666679) rotate(0 85.47860355050807 60.83333333333394)"><path d="M155.17 100.01 C159.55 104.12, 162.96 108.23, 169.46 120.52 M155.17 100.01 C161.14 107.74, 165.99 113.87, 169.46 120.52" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(527.8512166341147 11156.666666666684) rotate(0 89.91203308105469 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">UnlinkNode</text></g><g stroke-linecap="round" transform="translate(135.35121663411428 11672.500000000016) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C182.91 0.93, 337.57 0.67, 423 0 C440.93 -2.85, 457.21 13.44, 455 32 C455.01 91.84, 450.72 150, 455 256.33 C456.8 280.77, 443.2 289.37, 423 288.33 C272.53 286.89, 120.03 288.23, 32 288.33 C9.35 289.08, -2.52 278.9, 0 256.33 C4.43 177.48, 2.21 100.18, 0 32 C-3 9.28, 9.83 1.88, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C125 -0.63, 219.82 -0.64, 423 0 M32 0 C143.76 0.51, 255.94 0.48, 423 0 M423 0 C444.69 -1.08, 454.18 10.9, 455 32 M423 0 C446.41 1.97, 454.55 9.91, 455 32 M455 32 C455.17 102.51, 454.41 169.87, 455 256.33 M455 32 C452.69 105.16, 452.64 177.69, 455 256.33 M455 256.33 C453.29 277.49, 442.89 289.83, 423 288.33 M455 256.33 C454.97 277.35, 442.88 288.16, 423 288.33 M423 288.33 C278.1 290.89, 134.37 289.49, 32 288.33 M423 288.33 C270.05 290.6, 116.06 290.31, 32 288.33 M32 288.33 C12.18 289.36, -0.59 277.33, 0 256.33 M32 288.33 C9.52 289.23, -0.75 279.95, 0 256.33 M0 256.33 C0.46 210.11, 1 164.09, 0 32 M0 256.33 C-0.97 181.27, -1.04 106.43, 0 32 M0 32 C-0.33 8.79, 12.54 -1.26, 32 0 M0 32 C-2.09 10.21, 9.05 -0.5, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(259.6391805013018 11794.166666666684) rotate(0 103.2120361328125 22.5)"><text x="103.2120361328125" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Main tablet</text></g><g stroke-linecap="round" transform="translate(917.0178833007812 11635.833333333338) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C159.55 -2.44, 292.33 0.83, 423 0 C442.99 -2.35, 457.48 13.31, 455 32 C454.29 108.38, 451.76 180.32, 455 256.33 C458.06 279.76, 443.21 288.38, 423 288.33 C308.11 291.05, 193.27 291.33, 32 288.33 C12.41 286.8, 2.52 281.1, 0 256.33 C-3.4 192.9, -1.54 133.46, 0 32 C-1.4 10.67, 11.05 2.47, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C186.75 -1.21, 341.53 -2.11, 423 0 M32 0 C144.45 0.08, 256.46 0.46, 423 0 M423 0 C446.14 1.71, 454.61 10.01, 455 32 M423 0 C444.5 -0.7, 456.95 11.68, 455 32 M455 32 C455.45 118.38, 453.57 207.08, 455 256.33 M455 32 C453.1 96.57, 453.22 161.93, 455 256.33 M455 256.33 C454.98 277.39, 443.07 288.18, 423 288.33 M455 256.33 C456.59 275.7, 445.92 287.25, 423 288.33 M423 288.33 C273.85 287.38, 123.45 288.63, 32 288.33 M423 288.33 C272.02 289.49, 119.99 289.09, 32 288.33 M32 288.33 C9.67 289.11, -0.65 279.66, 0 256.33 M32 288.33 C8.42 287, 2.07 276.78, 0 256.33 M0 256.33 C0.71 201.07, 1.21 144.07, 0 32 M0 256.33 C0.1 195.51, 1.05 135.76, 0 32 M0 32 C-1.82 10.27, 9.26 -0.43, 32 0 M0 32 C2.08 10.89, 10.51 -2.01, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(956.6918334960938 11757.500000000005) rotate(0 187.8260498046875 22.5)"><text x="187.8260498046875" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Removes OpLog entry</text></g><g stroke-linecap="round"><g transform="translate(593.1964416503897 11811.25000000001) rotate(0 160.45238749186387 -24.537530339055593)"><path d="M0.04 -0.15 C53.52 -8.31, 268.33 -41.02, 321.84 -49.28 M-1.4 -1.28 C51.92 -9.23, 267.74 -39.94, 321.39 -47.85" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(593.1964416503897 11811.25000000001) rotate(0 160.45238749186387 -24.537530339055593)"><path d="M299.36 -36.03 C307.53 -38.98, 315.83 -44.68, 321.39 -47.85 M299.36 -36.03 C305.73 -38.11, 310.05 -42.2, 321.39 -47.85" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(593.1964416503897 11811.25000000001) rotate(0 160.45238749186387 -24.537530339055593)"><path d="M296.91 -52.95 C305.97 -49.45, 315.2 -48.72, 321.39 -47.85 M296.91 -52.95 C303.82 -50.87, 308.74 -50.8, 321.39 -47.85" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(651.1845499674478 11711.666666666673) rotate(0 104.32603454589844 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">LocalDB tx</text></g><g stroke-linecap="round" transform="translate(123.68454996744731 12124.166666666673) rotate(0 227.4999999999999 144.16666666666788)"><path d="M32 0 C124.39 -4.37, 215.65 -1.96, 423 0 C447.44 -1.14, 456.04 13.72, 455 32 C453.67 109.44, 455.65 191.57, 455 256.33 C455.75 275.15, 445.56 290.08, 423 288.33 C321.83 292.74, 221.71 290.5, 32 288.33 C9.28 287.5, 1.88 276.27, 0 256.33 C-1.06 188.46, 1.32 120.14, 0 32 C-3.54 10.16, 13.35 -2.46, 32 0" stroke="none" stroke-width="0" fill="#ffffff"></path><path d="M32 0 C179.26 -0.89, 327.91 0.64, 423 0 M32 0 C182.84 0.57, 334.09 1.01, 423 0 M423 0 C446.18 -0.01, 455.03 11.2, 455 32 M423 0 C442.14 -1.9, 453.72 10.39, 455 32 M455 32 C452.96 84.51, 454.4 139.48, 455 256.33 M455 32 C454.38 95.5, 454.38 160.07, 455 256.33 M455 256.33 C456.68 277.78, 443.61 290.19, 423 288.33 M455 256.33 C454.73 279.44, 446.54 290.34, 423 288.33 M423 288.33 C301.72 289.72, 179.04 289.48, 32 288.33 M423 288.33 C289.97 290.26, 158.59 290.37, 32 288.33 M32 288.33 C9.67 288.2, -1.75 278.33, 0 256.33 M32 288.33 C11.78 289.78, -0.11 276.92, 0 256.33 M0 256.33 C-0.86 193.49, -0.33 125.87, 0 32 M0 256.33 C2.14 193.56, 1.3 129.86, 0 32 M0 32 C0.63 10.75, 11.05 -1.89, 32 0 M0 32 C-1.82 12.08, 12.44 -0.86, 32 0" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(155.76244608561137 12245.833333333341) rotate(0 195.42210388183594 22.5)"><text x="195.42210388183594" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="middle" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">TStorageServiceActor</text></g><g stroke-linecap="round"><g transform="translate(359.51788330078125 11960.00000000001) rotate(0 -12.5 85)"><path d="M1.08 1.03 C-3.04 29.27, -20.9 141.5, -25.24 169.6 M0.19 0.52 C-4.07 28.92, -22 142.56, -26.31 170.93" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(359.51788330078125 11960.00000000001) rotate(0 -12.5 85)"><path d="M-31.16 146.41 C-28.16 152.33, -29.27 159.22, -26.31 170.93 M-31.16 146.41 C-28.72 152.99, -28.32 159.87, -26.31 170.93" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g><g transform="translate(359.51788330078125 11960.00000000001) rotate(0 -12.5 85)"><path d="M-14.26 149.03 C-15.64 154.42, -21.14 160.63, -26.31 170.93 M-14.26 149.03 C-16.4 154.98, -20.55 161.16, -26.31 170.93" stroke="#1e1e1e" stroke-width="2" fill="none"></path></g></g><mask></mask><g transform="translate(379.51788330078125 12016.666666666673) rotate(0 168.60804748535156 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">UnlinkNodeResponse</text></g><g transform="translate(58.85227457682231 12518.33333333335) rotate(0 809.6942749023438 67.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">If UnlinkNode in shard request fails, it's retried until it succeeds. If main tablet reboots,</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">it reads OpLog into its memory and again retries all shard requests until they</text><text x="0" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">succeed.</text></g><g transform="translate(53.811269124348655 12701.666666666673) rotate(0 329.98211669921875 22.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1971c2" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">ListNodes, GetNodeAttr and the like</text></g><g transform="translate(60.30572509765534 12790.000000000005) rotate(0 894.1162109375 472.5)"><text x="0" y="31.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">Node attributes are stored in shards for the inodes that are managed by the shards. So</text><text x="0" y="76.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">GetNodeAttr / GetNodeXAttr requests without the Name parameter (i.e. request that</text><text x="0" y="121.71600000000001" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">explicitly specify target NodeId) go directly to the shards. Requests that specify the</text><text x="0" y="166.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">parent NodeId + child Name pair first go through the main tablet which returns the</text><text x="0" y="211.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">{ShardId, NameInShard} pair to TStorageServiceActor which then sends the request to</text><text x="0" y="256.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">the right shard.</text><text x="0" y="301.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"></text><text x="0" y="346.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">ListNodes is a bit more tricky since it actually needs not only to list the names of the files,</text><text x="0" y="391.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">but to fetch node stat (i.e. GetNodeAttr results). We have a special GetNodeAttrBatch</text><text x="0" y="436.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">method which allows to fetch stat info for multiple files at the same time. So ListNodes</text><text x="0" y="481.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">is generally processed by TStorageServiceActor in the following 2 steps:</text><text x="0" y="526.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">1. ListNodes in main tablet - returns Names for the nodes under parent NodeId, returns stat</text><text x="0" y="571.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    info for the nodes managed directly by the main tablet (these are mostly directories</text><text x="0" y="616.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    and symlinks) and returns {ShardId, NameInShard} pairs for external nodes</text><text x="0" y="661.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">2. {ShardId, NameInShard} pairs are grouped by ShardId and GetNodeAttrBatch requests</text><text x="0" y="706.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">    are sent to shards</text><text x="0" y="751.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic"></text><text x="0" y="796.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">There is also a chance of UnlinkNode/RenameNode request completing between the 2 aforementioned</text><text x="0" y="841.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">steps. ListNodes logic in TStorageServiceActor does some extra steps if such a race is detected</text><text x="0" y="886.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">to verify that the nodes for which GetNodeAttrBatch returns ENOENT were actually deleted</text><text x="0" y="931.716" font-family="Virgil, Segoe UI Emoji" font-size="36px" fill="#1e1e1e" text-anchor="start" style="white-space: pre;" direction="ltr" dominant-baseline="alphabetic">by the user and not just lost due to some bug.  </text></g></svg>